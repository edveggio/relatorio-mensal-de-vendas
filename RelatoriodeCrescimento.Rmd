---
title: "Relatório mensal de Crescimento"
output:
  html_document: default
  pdf_document: default
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r bibliotecas, include=FALSE}
#Relatório mensal de vendas

if (!require(dplyr)) install.packages("dplyr")
if (!require(readr)) install.packages("readr")
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(plotly)) install.packages("plotly")
if (!require(readxl)) install.packages("readxl")
if (!require(lubridate)) install.packages("lubridate")
if (!require(zoo)) install.packages("zoo")
if (!require(sunburstR)) install.packages("sunberstR")
if (!require(forecast)) install.packages("forecast")
if (!require(stringr)) install.packages("stringr")
if (!require(DT)) install.packages("DT")
if (!require(htmltools)) install.packages("htmltools")

```

Oi pessoal,

Muito em breve esse relatório, que anda lá muito simples é verdade, deve ganhar mais musculatura. Construir um [sunbrst](http://rstudio-pubs-static.s3.amazonaws.com/495237_5336f47cb4df483f8f2780cd92066449.html) para nossos produtos, um [sankey](https://www.r-graph-gallery.com/sankey-diagram.html) mostrando os caminhos dos clientes entre meios de marketing e produtos além de outros dados como o Custo de Aquisição do Cliente (CAC), Tempo de vida do cliente (Lifetime e Lifetime value) estão todos no nosso radar. Só estamos esperando a construção do novo Processo de vendas.

O GT de Processo de vendas está a todo vapor, abaixo você encontra um recorte do cronograma, que está se cumprindo bastante bem. 

![](GT_processo_vendas.png)

## Vendas
```{r vendas semestre, echo=FALSE, message=FALSE, warning=FALSE, results = "hide"}
pipe_FunildeVendas<- read_delim("pipe Funil de Vendas.csv", ";", escape_double = FALSE, locale = locale(), 
                                  trim_ws = TRUE)
not_all_na <- function(x) {!all(is.na(x))}

pipe_FunildeVendas <- pipe_FunildeVendas %>% select_if(not_all_na)

important_columns <- c("ID", 
                       "Pipeline",
                       "Fase",
                       "Responsável", 
                       "Nome do negócio", 
                       "Tipo", 
                       "Renda",
                       "Empresa", 
                       "Data de início", 
                       "Data de fechamento",
                       "Produto",
                       "Origem da Oportunidade", 
                       "Deal de:" )

pipe_FunildeVendas <- subset.data.frame(pipe_FunildeVendas, select= important_columns)

pipe_FunildeVendas <- pipe_FunildeVendas[!is.na(pipe_FunildeVendas$Pipeline) & pipe_FunildeVendas$Pipeline == "Funil de vendas",]
pipe_FunildeVendas$`Data de fechamento` <- as.Date(x = pipe_FunildeVendas$`Data de fechamento`, format = "%d/%m/%Y")
pipe_FunildeVendas$`Data de início` <- as.Date(x = pipe_FunildeVendas$`Data de início`, format = "%d/%m/%Y")
pipe_FunildeVendas$"endQuarter" <- quarters(pipe_FunildeVendas$`Data de fechamento`) 
pipe_FunildeVendas$"startQuarter" <- quarters(pipe_FunildeVendas$`Data de fechamento`)
pipe_FunildeVendas$Renda <- as.numeric(pipe_FunildeVendas$Renda)
pipe_FunildeVendas %>% 
  mutate_at(vars(Renda), funs(round(x = ., digits = 0)))


QuarterSales <- pipe_FunildeVendas%>%
  filter(Fase == "Ganho Fechado")
  
QuarterSalesSum <- QuarterSales %>% 
  group_by(`endQuarter`, Ano = format(`Data de fechamento`, "%Y" )) %>%
  summarise(Renda = sum(Renda)) 
 
 QuarterSalesSum <- QuarterSalesSum %>% 
  mutate(Rendaper1000 = Renda/1000 ) 
 
QuarterSalesSum$Rendaper1000 <- round(QuarterSalesSum$Rendaper1000, 0)

Q1SalesSum <- QuarterSalesSum %>% 
  filter(endQuarter == "Q3" & Ano != 2017)

ggplot(data = Q1SalesSum, mapping = aes(x = Q1SalesSum$Ano, y = Q1SalesSum$Rendaper1000, label = Q1SalesSum$Rendaper1000))+
  geom_col(fill = "red", color = "black") +
  geom_text(size = 4,position = position_stack(vjust = 1.1)) +
  ylab("Renda em milhares de R$") +
  xlab("Ano") +
  ggtitle("Renda no 3º trimestre de cada ano" ) +
  theme_minimal()

```
  
  Mantendo nosso padrão faremos uma análise no trimestre e então focamos o mês. 
  Começamos o o 3º Trimestre muitíssimo bem, já somando mais de 50% das vendas esperadas pro período se comparado com 2019. 
  A Venda do OR pra Linx prova que de fato os primeiros impactos da pandemia já passaram. 
  
  
```{r vendas mensal,  echo=FALSE, message=FALSE, warning=FALSE, results = "hide"}

MonthSales <- pipe_FunildeVendas %>%
  filter(Fase == "Ganho Fechado")

MonthSales <- MonthSales %>% 
  rename ("Deal_de" = `Deal de:`)

MonthSalesSum <- MonthSales %>% 
  group_by("Data_de_fechamento" = month(`Data de fechamento`), Ano = format(`Data de fechamento`, "%Y" )) %>%
  summarise(Renda = sum(Renda))

 MonthSalesSum <- MonthSalesSum %>% 
  mutate(Rendaper1000 = Renda/1000 ) 
 
 MonthSalesSum$Rendaper1000 <- round(MonthSalesSum$Rendaper1000, 0)
 
 AbrilSalesSum <- MonthSalesSum %>% 
  filter(Data_de_fechamento == (month(Sys.Date())-1) & Ano > (year(Sys.Date())-3))

ggplot(data = AbrilSalesSum, mapping = aes(x = AbrilSalesSum$Ano, y = AbrilSalesSum$Rendaper1000, label = AbrilSalesSum$Rendaper1000))+
  geom_col(fill = "red", color = "black") +
  geom_text(size = 4,position = position_stack(vjust =1.1)) +
  ylab("Renda em milhares de R$") +
  xlab("Ano") +
  ggtitle(sprintf("Renda em %s de cada ano", month(floor_date(Sys.Date(), "month") - months(1), label = TRUE, abbr = FALSE))) +
  theme_minimal()
```
  
 O mês de Julho em 2020 sozinho já superiu em  8,5% o Julho ano anterior, completando assim nosso terceiro mês de vendas melhores do que o ano passado. 
  
  Logo em breve teremos análises mais detalhadassobre cada produto correlacionado com suas metas.
  
```{r echo=FALSE, message=FALSE, warning=FALSE}
SalesSumbyMonthandDeal <- MonthSales %>% 
  group_by(Deal_de, "Data_de_fechamento" = month(`Data de fechamento`), Ano = format(`Data de fechamento`, "%Y" ) ) %>%
  summarise(Renda = sum(Renda))

SalesSumbyMonthandDeal <- SalesSumbyMonthandDeal %>% 
  mutate(Rendaper1000 = Renda/1000 ) 
 
SalesSumbyMonthandDeal$Rendaper1000 <- round(SalesSumbyMonthandDeal$Rendaper1000, 0)
 
ThisMonthSalesSum <- SalesSumbyMonthandDeal %>% 
  filter(Data_de_fechamento == (month(Sys.Date())-1) & Ano > (year(Sys.Date())-3))

```

```{r sunburst, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
ThisMonthSalesSumSunburst <- read_delim("ThisMonthSalesSum.csv", 
    ";", escape_double = FALSE, locale = locale(encoding = "ISO-8859-1"), 
    trim_ws = TRUE)
ThisMonthSalesSumjson <- ThisMonthSalesSumSunburst[,5:6]

sunburst(data = ThisMonthSalesSumjson, percent = TRUE, count = TRUE)

```
  
## Tarefas Atrasadas
```{r tarefasAtrasadas, echo=FALSE, message=FALSE, warning=FALSE}
tarefas <- read_excel("tarefas Bitrix.xlsx")

tarefas$Deadline <- as.Date(x = tarefas$Deadline, format = "%d/%m/%Y")
tarefas$`Responsible person` <- as.factor(x = tarefas$`Responsible person`)

importantPeople <- as.factor(c("Julia Couto",
                     "Daniel Eloi",
                     "Andressa Morais",
                     "Laura Vianna",
                     "Carlos Carvalho",
                     "Henrique Rocha",
                     "Vitor Almeida",
                     "Leandro Rangel",
                     "Diego Stehling",
                     "Pedro Gonçalvez",
                     "Alysson Vidotti", 
                     "Pedro Gonçalves",
                     "Francine Marinho",
                     "Gustavo Fernandes"
                     ))
  
tarefasAtrasadas <- tarefas %>% 
  filter(Status == "Pending", Deadline < Sys.Date())

tarefasAtrasadas <- tarefasAtrasadas%>% 
  filter(`Responsible person` %in% importantPeople)

xlim_tarefasAtrasadas <- table(tarefasAtrasadas$`Responsible person`)

ggplot(data = tarefasAtrasadas, mapping = aes(x = `Responsible person`)) +
  geom_bar(fill = "red", color = "black") +
  theme(axis.text.x = element_text(angle = 90, hjust = -1)) +
  geom_text(stat='count', aes(label=..count..), vjust=0.5, hjust= 1.5 ) +
  ggtitle("Tarefas Atrasadas") +
  xlab("Pessoa Responsável") +
  ylab("Contagem") +
  #ylim(0, max(xlim_tarefasAtrasadas) +1 ) +
  coord_flip() +
  theme_minimal()

```

As tarefas atrasadas estão sob controle faz algumas semanas, ninguem tem tido problema mais sério. 

## Tarefas Completadas

```{r tarefas_completas, echo=FALSE}

tarefas_completas <- tarefas %>% 
  filter(Status == "Completed", month(Deadline) == month(Sys.Date())-1 & year(Deadline) == year(Sys.Date()))

tarefas_completas <- tarefas_completas%>% 
  filter(`Responsible person` %in% importantPeople)

ggplot(data = tarefas_completas, mapping = aes(x = `Responsible person`)) +
  geom_bar(fill = "aquamarine1", color = "black") +
  theme(axis.text.x = element_text(angle = 90, hjust = -1)) +
  geom_text(stat='count', aes(label=..count..), vjust=0.5, hjust= 1.5 ) +
  ggtitle("Tarefas Completadas") +
  xlab("Pessoa Responsável") +
  ylab("Contagem") +
  #ylim(0, max(xlim_tarefasAtrasadas) +1 ) +
  coord_flip() +
  theme_minimal()

```
  
  Nos proximos meses começaremos a avaliar também as tarefas que tem sido cumpridas. O gráfico acima deve ter algumas distorções já que nem todas a tarefas estão sendo criadas com o responsáveis corretos, algo me vamos melhoras no Bitrix paulatinamente 
  
```{r tarefas sem deal e tarefas sem data, message=FALSE, warning=FALSE, include=FALSE}

tarefasSemDeal <- tarefas %>% 
  filter(Status == "Pending",  is.na(CRM))

tarefasSemData <- tarefas %>% 
  filter(Status == "Pending",  is.na(Deadline))

tarefas_com_ploblemas <- dplyr::union(tarefasSemData, tarefasSemDeal)

write.csv2(tarefas_com_ploblemas, file = "tarefas com problemas.csv")

```
  
## Tarafas com problemas

```{r echo=FALSE}
tarefas_com_problemas_DT <-DT::datatable(tarefas_com_ploblemas, options = list(
  order = list(list(4, 'asc')))) %>% 
  DT::formatStyle (
    'Responsible person',
    backgroundColor = DT::styleEqual(NA, c('red')))

htmlwidgets::saveWidget(tarefas_com_problemas_DT, "tarefas_com_problemasDT.html")

tarefas_com_problemas_DT
```
 
  Semanalmente estamos gerando uma lista de tarefas que podem indicar algum problemas, seja porque não tem data para terminar seja porque não estão vinculadas à um negócio. As pessoas responsáveis na lista são avisadas. Essa lista também nos permite agir preventivamente frente a erros de automações. 
  A ação preventiva nas automações já tem mostrado efeito, temos um número constante menor de tarefas com problema. Caimos, em 8 semanas, de 42 para 12. Além disso conseguimos desafogar outras pessoas chaves de uma verificação chata.
  
```{r indicadores de SaaS, echo=FALSE, message=FALSE, warning=FALSE}

Fluxo_de_caixa_2020_projecao <- read_delim("D:/Ed Velho/Documents/Relatorio mensal de vendas - Pris/06-Jun/Fluxo de caixa 2020 - projecao.csv", 
    ";", escape_double = FALSE, locale = locale(decimal_mark = ","), 
    trim_ws = TRUE, skip = 4)

names(Fluxo_de_caixa_2020_projecao)[4] <-paste("categoria")
names(Fluxo_de_caixa_2020_projecao)[2] <-paste("nome")

Fluxo_de_caixa_2020_projecao<- Fluxo_de_caixa_2020_projecao[,2:length(names(Fluxo_de_caixa_2020_projecao))]

Fluxo_de_caixa_2020_projecao <- Fluxo_de_caixa_2020_projecao[c(-2,-4,-5)]

projecao.as.numeric <- function(x){
  x <- as.numeric(gsub(",", ".", gsub("\\.", "", x)))
}

meses_custo <- Fluxo_de_caixa_2020_projecao[,3:length(names(Fluxo_de_caixa_2020_projecao))]

meses_custo <- apply(meses_custo, 2, projecao.as.numeric)

Fluxo_de_caixa_2020_projecao[,3:length(names(Fluxo_de_caixa_2020_projecao))] <- meses_custo

alocacao_pessoas_MKT <- data.frame("nomes" = c("Daniel Eloi", "Francine de Oliveira Marinho","Gustavo Fernandes Dias","Pedro Henrique de Oliveira Gonçalves","Carlos Henrique de Carvalho Junior","Lorena Gabrielle de Souza Ribeiro","Alysson Vidotti","Leandro de Alencar Rangel","Rheubert Lucas Resende Rodigues Velho", "Diego Moreira"), 
"alocacao" = c( 0.5, 0.9, 0.9, 0.8, 0.7, 0.5, 0.5, 0.7, 0.4, 0.1))

custos_diretos_MKT <- Fluxo_de_caixa_2020_projecao %>% 
  filter(str_detect(categoria, "Marketing e Vendas"))

custos_pessoas_MKT <- Fluxo_de_caixa_2020_projecao %>% 
  filter(nome %in% alocacao_pessoas_MKT$nomes)

sum_custos_diretos_MKT <-apply(custos_diretos_MKT[,3:dim(custos_diretos_MKT)[2]], 2, FUN = sum, na.rm = TRUE)

sum_custos_diretos_MKT <- as.data.frame(t(sum_custos_diretos_MKT))

sum_custos_diretos_MKT_this_month <- sum_custos_diretos_MKT$`jun/20`

custos_pessoas_MKT_by_month <- custos_pessoas_MKT %>% 
  group_by(nome) %>% 
  summarise_at(vars(-categoria), sum, na.rm = TRUE)

alocacao_pessoas_MKT <- alocacao_pessoas_MKT[order(alocacao_pessoas_MKT$nomes),]

custos_pessoas_MKT_by_month <- custos_pessoas_MKT_by_month[order(custos_pessoas_MKT_by_month$nome),]

sum_custos_pessoas_MKT <-apply(custos_pessoas_MKT[,3:dim(custos_pessoas_MKT)[2]], 2, FUN = sum, na.rm = TRUE)

custos_pessoas_MKT_by_month_by_alocacao <- custos_pessoas_MKT_by_month[,-1] * alocacao_pessoas_MKT$alocacao

custos_pessoas_MKT_by_month_by_alocacao <- cbind(nome = custos_pessoas_MKT_by_month$nome, custos_pessoas_MKT_by_month_by_alocacao) 

total_custos_pessoas_MKT_by_month_by_alocacao <- as.data.frame(t(colSums(custos_pessoas_MKT_by_month_by_alocacao[,-1])))

new_clients_by_month <- MonthSales %>% 
  group_by("Data_de_fechamento" = month(`Data de fechamento`), Ano = as.numeric(format(`Data de fechamento`, "%Y" ))) %>%
  summarise(contagem = dplyr::n())

new_clients_this_month <- new_clients_by_month %>% 
  filter(Ano == year(Sys.Date()), Data_de_fechamento == month(Sys.Date())-1)

new_clients_by_month <- new_clients_by_month[order(new_clients_by_month$Ano, new_clients_by_month$Data_de_fechamento),]

ts_new_clients <- ts(new_clients_by_month$contagem, frequency = 12, start = c(2017, 4))


#CAC <- to/ new_clients_this_month$contagem
```

